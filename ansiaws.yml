- hosts: localhost
  connection: local
  gather_facts: False
  vars:
      instance_type: t2.micro
      security_group: buildsrv2 
      image: ami-08bac620dc84221eb
      region: eu-west-1 
      keypair: ansible
      count: 2
      #we need 2 instances sooo,,

  tasks:

# we skip creation of keys, done outside already

    - name: Ensure creation of a security group
      ec2_group: 
        name: "{{ security_group }}"
        description: Security Group for prod pods
        region: "{{ region }}"
        rules:
          - proto: tcp
            ports: 
              - 22
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            ports:
              - 8080
            cidr_ip: 0.0.0.0/0
        rules_egress:
          - proto: all
            cidr_ip: 0.0.0.0/0 
      register: security_group

    - name: Ensure that there are "{{count}}" EC2 instances will be created or running already 
      ec2:
        group: "{{ security_group }}"
        instance_type: "{{ instance_type}}"
        image : "{{ image }}"
        wait : true
        region : "{{ region }}"
        keypair : "{{ keypair }}"
        count: "{{count}}"
        instance_tags:
          Name: prod
          Name: prod2
        state: running
      register: ec2


